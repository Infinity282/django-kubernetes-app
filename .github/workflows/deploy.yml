name: Build, Push to Private Registry and Deploy with Helm
on:
  push:
    branches: [ main ]
env:
  REGISTRY: "192.168.0.115:30500"
  IMAGE_NAME: "django-app"
  K8S_NAMESPACE: "django-app"
  HELM_RELEASE: "django-app-production"
jobs:
  build-and-push:
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Log in to private registry
      run: |
        docker login ${{ env.REGISTRY }} -u admin -p admin123
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        outputs: |
          type=registry,ref=192.168.0.115:30500/django-app:latest,insecure=true
          type=registry,ref=192.168.0.115:30500/django-app:${{ github.sha }},insecure=true
        cache-from: type=registry,ref=192.168.0.115:30500/django-app:buildcache
        cache-to: type=registry,ref=192.168.0.115:30500/django-app:buildcache,mode=max

  deploy-with-helm:
    needs: build-and-push
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: "3.12.0"
    - name: Set up Kubeconfig
      uses: azure/k8s-set-context@v3
      with:
        kubeconfig: ${{ secrets.KUBE_CONFIG }}
    - name: Add Helm repositories
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add bitnami https://mirror.yandex.ru/helm/charts.bitnami.com
        helm repo update
    - name: Deploy with Helm
      run: |
        # Upgrade or install application
        helm upgrade --install ${{ env.HELM_RELEASE }} ./django-app-chart \
          --namespace ${{ env.K8S_NAMESPACE }} \
          --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
          --set image.tag=latest \
          --set app.replicas=3 \
          --create-namespace \
          --wait \
          --timeout 300s
        # Check status
        helm list --namespace ${{ env.K8S_NAMESPACE }}
        kubectl get pods,svc -n ${{ env.K8S_NAMESPACE }}
    - name: Run database migrations
      run: |
        # Получаем имя одного из подов
        POD_NAME=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l "app.kubernetes.io/name=django-app" -o jsonpath='{.items[0].metadata.name}')
        # Выполняем миграции
        # kubectl exec -n ${{ env.K8S_NAMESPACE }} $POD_NAME -- python manage.py migrate
        # Собираем статику
        # kubectl exec -n ${{ env.K8S_NAMESPACE }} $POD_NAME -- python manage.py collectstatic --noinput
  smoke-test:
    needs: deploy-with-helm
    runs-on: self-hosted
    steps:
    - name: Check application health
      run: |
        # Получаем URL приложения
        APP_URL=$(kubectl get ingress -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.items[0].spec.rules[0].host}')
        # Проверяем health endpoint
        curl -f http://$APP_URL/health/
        # Проверяем метрики
        curl -f http://$APP_URL/metrics/